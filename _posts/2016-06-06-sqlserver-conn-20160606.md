---
layout: post
title: SQL Server的连接
categories:  delphi之数据库 数据库之sql 数据库之sqlserver
tags: delphi oracle SQLServer 数据库 数据库连接  
---

##扩展资料

* [《亲测SQLServer的最大连接数》](http://www.cnblogs.com/wlb/archive/2012/04/08/2437617.html)
* [《SQL Server 和 Oracle 以及 MySQL 有哪些区别？》](https://www.zhihu.com/question/19866767)
* [《SQL Server 查询性能优化 相关文章》](http://www.cnblogs.com/xcsn/p/4929724.html)
* [《W3School SQL 教程》](http://www.w3school.com.cn/sql/index.asp)

##提前了解

* 获取当前SQL Server连接数配置：
  * `select value from  master.dbo.sysconfigures where [config]=103`
  * 默认是0，代表不限制，但最大连接数是32767
* 设置SQL Server的最大连接数限制
  * `exec sp_configure 'show advanced options', 1` 
  * 设置show advanced options 值为1 才能允许下面对数据库连接数进行设置
  * 执行`RECONFIGURE`语句使之生效
  * `exec sp_configure 'user connections', 100`
  * 用以配置最大连接数为100
  * 执行`RECONFIGURE`语句使之生效
  * **但此时并没有真正生效，需重启SQL Server的服务才能生效**
  * 重启服务：打开SQL Server Management Studio-->右键数据库实例-->重新启动
* 更多有用的SQL命令介绍
  * 查看已经使用的连接数个数：`select count(*) from sys.dm_exec_connections`
  * 查看当前所有连接的详细信息：`select * from sys.dm_exec_connections`
  * 查看当前有多少会话：`select count(*) from sys.dm_exec_sessions`
  * 一个连接可以有多个会话
  * 查看当前所有会话的详细信息：`select * from sys.dm_exec_sessions`
  
##意外经历

* 第一次编程测试数据库连接数限制时，使用上面的设置连接数限制为1
* 但是没有重启，所以测试一直不明白为什么数据库连接数限制设置好无效
* 就暂隔一边没有再管
* 几天后重启机器，使用SQL Server Management Studio登录报错
* 报错信息：已成功与服务器建立连接，但是在登录过程中发生错误。 
* 报错信息续：(provider: 共享内存提供程序, error: 0 - 管道的另一端上无任何进程。)
* Google了好多博客都没有解决这个问题
* 想到之前测试数据库连接时，将数据库连接数限制设置为1
* 后来重启机器相当于重启服务，导致之前的数据库连接数设置生效了
* 现在使用SQL Server Management Studio登录，底层也是需要建立连接的，不过限制最多为1，所以报错
* 解决方法：重新设置数据库的最大连接数
* 因为无法登陆，所以暂时无法使用SQL 来重设
* 打开SQL Server Management Studio，右键数据库实例-->属性-->连接，重新设置连接数，再重启服务即可
* 上面不需要登录，只要连接上就可以设置，可能有时候需要重启机器，重新连接SQL Server

##疑问列举

* 连接和会话的关系？
* 长连接和短连接？
* SQL Server连接和Oracle连接？
* 数据库连接和网络连接？

##编程测试SQL Server连接

* 假如使用上面的方法设置SQL Server的最大连接数为100
* 测试任务的界面可以参见下图
* 分别测试“使用连接池”和“不使用连接池”，详细运行效果看下面的图
* 暂时没有发现在使用上面的方法设置数据库连接时是否用连接池的差异点！

##运行效果图展示

###程序打开

###不使用连接池

###使用连接池

##源码展示

```
unit Unit1;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, StdCtrls, DB, ADODB, ExtCtrls;
const
  SQLConnStr = 'Provider=%0:s;User ID=%s;Password=%s;Data Source=%s;Persist Security Info=True';

type
  TForm1 = class(TForm)
    btn1: TButton;
    lbl5: TLabel;
    lbl6: TLabel;
    lbl7: TLabel;
    lbl8: TLabel;
    edt4: TEdit;
    edt5: TEdit;
    edt6: TEdit;
    cbb1: TComboBox;
    mmo1: TMemo;
    chk1: TCheckBox;
    procedure btn1Click(Sender: TObject);
    procedure FormCreate(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  Form1: TForm1;

implementation

{$R *.dfm}

procedure TForm1.btn1Click(Sender: TObject);
var
  ConnectionString: string;
  adoConn: TADOConnection;
  i: Integer;
begin
  btn1.Enabled := False;
  ConnectionString := Format(SQLConnStr, [cbb1.Text, edt4.Text, edt5.Text, edt6.Text]);
  if chk1.Checked then
  begin
    ConnectionString := ConnectionString + ';Pooling=true;Max Pool Size=40000;Min Pool Size=0;';
  end;

  try
    for i:= 1 to 40000 do
    begin
      Application.ProcessMessages;
      adoConn:= TADOConnection.Create(nil);
      adoConn.LoginPrompt := False;
      adoConn.ConnectionString := ConnectionString;
      adoConn.Open;
      mmo1.Lines.Add('创建连接:' + IntToStr(i));
    end;
  except
    on E: Exception do
    begin
      ShowMessage('出现异常，将自动关闭进程:' + E.Message);
      Application.Terminate;
    end;
  end;
end;

procedure TForm1.FormCreate(Sender: TObject);
begin

  cbb1.Items.Add('SQLOLEDB');
  cbb1.Items.Add('SQLNCLI');
  cbb1.ItemIndex := 0;                //程序启动时默认在窗体上显示第一项
  cbb1.Style := csOwnerDrawFixed;

  edt4.Text := 'sa';            //用户名
  edt5.Text := 'Xumeng@13245';  //密码
  edt6.Text := '127.0.0.1';     //数据源

end;

end.
```

---
layout: post
title: Delphi的DLL编程中使用COM
categories: delphi之dll 
tags: delphi dll com
---

在Delphi中使用COM的步骤为:

* 根据类型库文件生成声明单元(xxx_TLB.pas)
* 创建需要的COM对象或COM接口
* 使用COM对象（接口）的属性和方法完成操作
* 释放COM对象（COM接口系统会自动释放）

>注：一般程序中只适用COM接口和COM类对象中的一种，接口和对象最好不要混用。

Delphi使用COM前最好调用CoInitialize函数进行初始化，COM组件用完后要调用CoUninitialize函数反初始化。因为在Delphi的ComObj单元的initialization部分有以下一段代码： 

```
if not IsLibrary then 
begin 
  SaveInitProc := InitProc; 
  InitProc := @InitComObj; 
end; 
```

这段代码判断当前程序是否是一个DLL（通过IsLibrary变量来判断）如果不是的话，则将初始化的过程设为InitComObj函数。而DELPHI执行调用CoInitialize函数的操作正是在这个InitComObj函数中调用的,所以Delphi如果在普通DLL中调用COM组件不初始化的话就会报错。

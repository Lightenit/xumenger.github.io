---
layout: post
title: Oracle存储过程
categories:  深入学习之数据库原理 数据库之oracle 数据库之sql
tags: oracle sql 存储过程
---

下面只是很简单的初步了解一下存储过程，能够对存储过程有一个初步的认知，举的几个也都是极其简单的例子，还是有很多需要再深入学习的，比如

* 数据库游标
* 存储过程的异常处理

##先写一个简单的存储过程

```
create or replace procedure testproc  --test是存储过程名
is
id number;                           --声明变量，注意一定要有';'
begin
  id:= 1;                             --存储过程的主体
end testproc;                         --end 存储过程名
```

解释一下`create or replace`：如果原来没有存储过程test，则在此创建一个存储过程，否则会用现在的这个存储过程覆盖原来的存储过程

##传入参数

先创建一张表，执行的SQL如下

```
CREATE TABLE testtable
(
id number(10),
username varchar2(10)
);
```

下面实现一个给表插入记录的存储过程（注意参数的关键字in）

```

create or replace procedure test_insert(v_id in number,v_username in varchar2)
as
begin
  insert into testtable values (v_id, v_username);
end test_insert;
```

比如，这样调用就可以向数据表中插入记录了：

```
call test_insert(1, 'a_name');

--或者

declare
i_id number;
c_name varchar2(10);
begin
  i_id:= 2;
  c_name := 'test_name';
  test_insert(i_id, c_name);
end;
```

##传出参数

创建一个带输出参数的存储过程（注意参数的关键字out）

```
create or replace procedure test_select(v_id in number,v_username out varchar2)
as
begin
  select username into v_username from testtable where id = v_id; --变量赋值 
exception
when no_data_found then 
raise_application_error(-20001,'ID不存在!');
end test_select;
```

注意使用select语句时候要用select into

怎么测试呢？在PLSQL中打开一个Command Window，然后按照下面的顺序输入命令执行看效果

```
SQL> var c_name;
SQL> call test_select(1, :c_name);
Method called
c_name
---------
test_name

SQL> print c_name;
c_name
---------
test_name
```

>注意，在这里call test_select(1, :c_name);时候的输出参数需要使用 : 

##带判断的存储过程

判断一个数是不是偶数，代码如下：

```
create or replace procedure test_iseven(n in number, isEven out varchar2)
is
begin
isEven:='false';
if n mod 2 = 0 then         --特别注意，判断是不是等于的时候使用=而不是==
   begin
      isEven:='true';
   end;
end if;
end test_iseven;
```

在Command Window里面进行测试

```
SQL> var b varchar2;
SQL> call test_iseven(10, :b);
Method called
b
---------
true

SQL> call test_iseven(11, :b);
Method called
b
---------
false
```

##带循环的存储过程

一个计算从1开始累加的存储过程

```
create or replace procedure test_loop(endnum in number, loop_result out number)
is
i number:= 1;
begin
loop_result:= 0;
while i<= endnum loop
  begin
    loop_result:= loop_result + i;
    i:= i + 1;
  end;
end loop;
end test_loop;
```

在Command Windows测试一下

```
SQL> var loop_result number;
SQL> call test_loop(10, :loop_result);
Method called
loop_result
---------
55

SQL> print loop_result;
loop_result
---------
55
```
